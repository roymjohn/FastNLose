<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="FastNLose.MainPage"
             x:Name="page"
             BackgroundColor="{Binding IsAllCompleted, Converter={StaticResource BoolToGreen}}">

    <!-- Root layout -->
    <Grid RowDefinitions="Auto,*">

        <!-- ================= HEADER ================= -->
        <VerticalStackLayout Grid.Row="0" Spacing="4" Padding="6">

            <!-- Title -->
            <Label Text="CHATHA PATCHA"
                   FontSize="20"
                   HorizontalOptions="Center"
                   FontAttributes="Bold">
                <Label.GestureRecognizers>
                    <TapGestureRecognizer Tapped="OnTitleTapped" NumberOfTapsRequired="1" />
                </Label.GestureRecognizers>
            </Label>

            <!-- Date Navigator -->
            <Grid ColumnDefinitions="36,*,36"
                  Padding="4"
                  VerticalOptions="Center">

                <!-- PREV -->
                <Button
                    Grid.Column="0"
                    Text="◀"
                    WidthRequest="32"
                    HeightRequest="32"
                    CornerRadius="8"
                    Padding="0"
                    FontSize="14"
                    FontAttributes="Bold"
                    TextColor="White"
                    BackgroundColor="#5BC0FF"
                    IsEnabled="{Binding CanPrev}"
                    Command="{Binding PrevDatesCommand}" />

                <!-- DATE STRIP -->
                    <CollectionView
                    Grid.Column="1"
                    ItemsSource="{Binding VisibleDates}"
                    ItemsLayout="HorizontalList"
                    HorizontalScrollBarVisibility="Never"
                    VerticalOptions="Center"
                    HorizontalOptions="Center"
                    HeightRequest="39">

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Border HeightRequest="35" Padding="6"
       Background="{Binding Background}">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="18" />
                                </Border.StrokeShape>
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer
            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SelectDateCommand}"
            CommandParameter="{Binding}" />
                                </Border.GestureRecognizers>

                                <Label Text="{Binding Display}"
                                       TextColor="{Binding IsSelected, Converter={StaticResource BoolToTextColorConverter}}" />
                            </Border>

                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                </CollectionView>

                <!-- NEXT -->
                <Button
                    Grid.Column="2"
                    Text="▶"
                    WidthRequest="32"
                    HeightRequest="32"
                    CornerRadius="8"
                    Padding="0"
                    FontSize="14"
                    FontAttributes="Bold"
                    TextColor="White"
                    BackgroundColor="#5BC0FF"
                    IsEnabled="True"
                    InputTransparent="False"
                    ZIndex="10"
                    Command="{Binding NextDatesCommand}" />
            </Grid>
        </VerticalStackLayout>

        <!-- ================= MAIN CONTENT ================= -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="2" Padding="8"
                                 BindableLayout.ItemsSource="{Binding Categories}">

                <BindableLayout.ItemTemplate>
                    <DataTemplate>

                        <Border Background="{Binding Background}"
                               Padding="6" x:Name="sectionBorder">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>
                            <Border.Triggers>
                                <DataTrigger TargetType="Border" Binding="{Binding Key}" Value="16HR_FAST">
                                    <Setter Property="Padding" Value="3" />
                                </DataTrigger>
                                <DataTrigger TargetType="Border" Binding="{Binding Key}" Value="WEIGHT">
                                    <Setter Property="Padding" Value="3" />
                                </DataTrigger>
                                <DataTrigger TargetType="Border" Binding="{Binding Key}" Value="SUGAR_8AM">
                                    <Setter Property="Padding" Value="3" />
                                </DataTrigger>
                                <DataTrigger TargetType="Border" Binding="{Binding Key}" Value="STEPS">
                                    <Setter Property="Padding" Value="3" />
                                </DataTrigger>
                            </Border.Triggers>

                                <VerticalStackLayout x:Name="sectionStack" Spacing="2">
                                    <VerticalStackLayout.Triggers>
                                        <DataTrigger TargetType="VerticalStackLayout" Binding="{Binding Key}" Value="16HR_FAST">
                                            <Setter Property="Spacing" Value="1" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="VerticalStackLayout" Binding="{Binding Key}" Value="WEIGHT">
                                            <Setter Property="Spacing" Value="1" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="VerticalStackLayout" Binding="{Binding Key}" Value="SUGAR_8AM">
                                            <Setter Property="Spacing" Value="1" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="VerticalStackLayout" Binding="{Binding Key}" Value="STEPS">
                                            <Setter Property="Spacing" Value="1" />
                                        </DataTrigger>
                                    </VerticalStackLayout.Triggers>

                                <Grid>
                                    <!-- Stacked layout: title on first row, controls on second -->
                                    <VerticalStackLayout IsVisible="{Binding ForceStacked}" Spacing="1.5">
                                        <Label Text="{Binding Name}"
                                               FontAttributes="Bold"
                                               FontSize="14"
                                               Margin="0"
                                               VerticalOptions="Center"
                                               HorizontalOptions="Start"
                                               TextColor="{Binding TextColor}" />

                                        <HorizontalStackLayout Spacing="9" VerticalOptions="Center">
                                            <!-- Slots row for stacked layout -->
                                            <CollectionView ItemsSource="{Binding Slots}"
                                                            ItemsLayout="HorizontalList"
                                                            HeightRequest="31"
                                                            Margin="0"
                                                            HorizontalOptions="Start"
                                                            IsVisible="{Binding IsPicker, Converter={StaticResource InverseBoolConverter}}"
                                                            IsEnabled="{Binding IsEditable}">
                                                <CollectionView.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border HeightRequest="31"
                                                               Background="{Binding Color}"
                                                               Margin="3"
                                                               Padding="7,3"
                                                               HorizontalOptions="Center"
                                                               VerticalOptions="Center">
                                                            <Border.StrokeShape>
                                                                <RoundRectangle CornerRadius="{Binding CornerRadius}" />
                                                            </Border.StrokeShape>
                                                            <Border.Triggers>
                                                            <DataTrigger TargetType="Border" Binding="{Binding Label}" Value="{x:Null}">
                                                                    <Setter Property="WidthRequest" Value="27" />
                                                                    <Setter Property="HeightRequest" Value="35" />
                                                                    <Setter Property="Padding" Value="3" />
                                                                </DataTrigger>
                                                                <DataTrigger TargetType="Border" Binding="{Binding Label}" Value="">
                                                                    <Setter Property="WidthRequest" Value="27" />
                                                                    <Setter Property="HeightRequest" Value="35" />
                                                                    <Setter Property="Padding" Value="3" />
                                                                </DataTrigger>
                                                            </Border.Triggers>
                                                            <Border.GestureRecognizers>
                                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SlotTapCommand}" CommandParameter="{Binding}" />
                                                            </Border.GestureRecognizers>
                                                            <Label x:Name="slotLabel" Text="{Binding Value}"
                                                                   VerticalOptions="Center"
                                                                   HorizontalOptions="Center"
                                                                   FontSize="13"
                                                                   TextColor="{Binding State, Converter={StaticResource StateToTextColorConverter}}" />
                                                        </Border>
                                                    </DataTemplate>
                                                </CollectionView.ItemTemplate>
                                            </CollectionView>

                                            <!-- Picker for stacked layout -->
                                            <Picker ItemsSource="{Binding Items}"
                                                    SelectedItem="{Binding SelectedValue}"
                                                    HeightRequest="34"
                                                    WidthRequest="120"
                                                    HorizontalOptions="End"
                                                    TextColor="{Binding TextColor}"
                                                    IsVisible="{Binding IsPicker}"
                                                    SelectedIndexChanged="OnPickerSelectionChanged"
                                                    IsEnabled="{Binding IsEditable}" />

                                            <!-- Toggle for stacked layout -->
                                            <HorizontalStackLayout IsVisible="{Binding IsToggle}" VerticalOptions="Center" Spacing="6">
                                                <Label Text="No" VerticalOptions="Center" TextColor="{Binding TextColor}" />
                                                <Switch IsToggled="{Binding ToggleValue}" VerticalOptions="Center" IsEnabled="{Binding IsEditable}" />
                                                <Label Text="Yes" VerticalOptions="Center" TextColor="{Binding TextColor}" />
                                            </HorizontalStackLayout>
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>

                                    <!-- Inline layout: title and controls on same row -->
                                    <HorizontalStackLayout IsVisible="{Binding ForceStacked, Converter={StaticResource InverseBoolConverter}}" Spacing="12" VerticalOptions="Center">
                                        <Label Text="{Binding Name}" 
                                               FontAttributes="Bold"
                                               FontSize="14"
                                               Margin="0"
                                               VerticalOptions="Center"
                                               HorizontalOptions="StartAndExpand"
                                               TextColor="{Binding TextColor}" />

                                        <CollectionView x:Name="SlotsView" ItemsSource="{Binding Slots}"
                                                        ItemsLayout="HorizontalList" 
                                                        HeightRequest="40"
                                                        Margin="0"
                                                        HorizontalOptions="End"
                                                        IsVisible="{Binding IsPicker, Converter={StaticResource InverseBoolConverter}}"
                                                        IsEnabled="{Binding IsEditable}">
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                        <Border HeightRequest="31"
                                                               Background="{Binding Color}"
                                                               Margin="3"
                                                               Padding="6,0"
                                                           HorizontalOptions="Center"
                                                           VerticalOptions="Center">
                                                        <Border.StrokeShape>
                                                            <RoundRectangle CornerRadius="{Binding CornerRadius}" />
                                                        </Border.StrokeShape>
                                                            <Border.Triggers>
                                                            <DataTrigger TargetType="Border" Binding="{Binding Label}" Value="{x:Null}">
                                                                    <Setter Property="WidthRequest" Value="31" />
                                                                <Setter Property="HeightRequest" Value="35" />
                                                                    <Setter Property="Padding" Value="3" />
                                                                </DataTrigger>
                                                                <DataTrigger TargetType="Border" Binding="{Binding Label}" Value="">
                                                                    <Setter Property="WidthRequest" Value="31" />
                                                                <Setter Property="HeightRequest" Value="35" />
                                                                <Setter Property="Padding" Value="3" />
                                                                </DataTrigger>
                                                            </Border.Triggers>
                                                        <Border.GestureRecognizers>
                                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SlotTapCommand}" CommandParameter="{Binding}" />
                                                        </Border.GestureRecognizers>
                                                        <Label x:Name="slotLabel" Text="{Binding Value}" 
                                                               VerticalOptions="Center" 
                                                               HorizontalOptions="Center"
                                                               FontSize="12"
                                                               TextColor="{Binding State, Converter={StaticResource StateToTextColorConverter}}" />
                                                    </Border>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>

                                        <Picker x:Name="PickerView"
                                                ItemsSource="{Binding Items}"
                                                SelectedItem="{Binding SelectedValue}"
                                                HeightRequest="40"
                                                WidthRequest="140"
                                                HorizontalOptions="End"
                                                TextColor="{Binding TextColor}"
                                                IsVisible="{Binding IsPicker}"
                                                SelectedIndexChanged="OnPickerSelectionChanged"
                                                IsEnabled="{Binding IsEditable}" />

                                        <HorizontalStackLayout IsVisible="{Binding IsToggle}" VerticalOptions="Center" HorizontalOptions="End" Spacing="6">
                                            <Label Text="No" VerticalOptions="Center" TextColor="{Binding TextColor}" />
                                            <Switch IsToggled="{Binding ToggleValue}" VerticalOptions="Center" IsEnabled="{Binding IsEditable}" />
                                            <Label Text="Yes" VerticalOptions="Center" TextColor="{Binding TextColor}" />
                                        </HorizontalStackLayout>
                                    </HorizontalStackLayout>
                                </Grid>

                            </VerticalStackLayout>
                        </Border>

                    </DataTemplate>
                </BindableLayout.ItemTemplate>

            </VerticalStackLayout>
        </ScrollView>

        <!-- ================= COMPLETION MESSAGE ================= -->
        <Label Grid.Row="1"
               Text="🎉🎉 SUCCESS 🎉🎉"
               TextColor="White"
               FontSize="26"
               IsVisible="{Binding IsAllCompleted}"
               HorizontalOptions="Center"
               VerticalOptions="Center"/>

    </Grid>
</ContentPage>
